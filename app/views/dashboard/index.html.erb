<% content_for :title, "Dashboard" %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h1 class="mb-4">Dashboard de Orçamento Familiar</h1>
    </div>
  </div>

  <!-- Resumo Financeiro do Mês Atual -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-success">
        <div class="card-header">
          <i class="fas fa-arrow-up"></i> Receitas do Mês
        </div>
        <div class="card-body">
          <h4 class="card-title">R$ <%= number_with_delimiter(@current_month_income, delimiter: '.', separator: ',') %></h4>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-white bg-danger">
        <div class="card-header">
          <i class="fas fa-arrow-down"></i> Despesas do Mês
        </div>
        <div class="card-body">
          <h4 class="card-title">R$ <%= number_with_delimiter(@current_month_expenses, delimiter: '.', separator: ',') %></h4>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-white <%= @current_month_balance >= 0 ? 'bg-primary' : 'bg-warning' %>">
        <div class="card-header">
          <i class="fas fa-balance-scale"></i> Saldo do Mês
        </div>
        <div class="card-body">
          <h4 class="card-title">R$ <%= number_with_delimiter(@current_month_balance, delimiter: '.', separator: ',') %></h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Botões de Ação -->
  <div class="row mb-4">
    <div class="col-md-12">
      <h3>Adicionar Transação</h3>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#incomeModal">
          <i class="fas fa-plus-circle"></i> Adicionar Receita
        </button>
        <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#expenseModal">
          <i class="fas fa-minus-circle"></i> Adicionar Despesa
        </button>
      </div>
    </div>
  </div>

  <!-- Placeholder para Gráfico -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Distribuição de Despesas por Categoria</h5>
        </div>
        <div class="card-body">
          <canvas id="expenseChart" width="400" height="400"></canvas>
          <p class="text-muted text-center mt-3">
            <em>Gráfico será implementado posteriormente com Chart.js</em>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Evolução Mensal</h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyChart" width="400" height="400"></canvas>
          <p class="text-muted text-center mt-3">
            <em>Gráfico será implementado posteriormente com Chart.js</em>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Adicionar Receita -->
<div class="modal fade" id="incomeModal" tabindex="-1" aria-labelledby="incomeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="incomeModalLabel">
          <i class="fas fa-plus-circle"></i> Adicionar Receita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: [@current_user.family, Transaction.new], url: transactions_path, local: true, html: { class: "transaction-form" } do |form| %>
          <%= form.hidden_field :transaction_type, value: "income" %>

          <div class="mb-3">
            <%= form.label :description, "Descrição", class: "form-label" %>
            <%= form.text_field :description, class: "form-control", placeholder: "Ex: Salário, Freelance, etc." %>
          </div>

          <div class="mb-3">
            <%= form.label :amount, "Valor (R$)", class: "form-label" %>
            <%= form.number_field :amount, step: 0.01, min: 0, class: "form-control", placeholder: "0,00" %>
          </div>

          <div class="mb-3">
            <%= form.label :transaction_date, "Data", class: "form-label" %>
            <%= form.date_field :transaction_date, class: "form-control", value: Date.current %>
          </div>

          <div class="mb-3">
            <%= form.label :category_id, "Categoria", class: "form-label" %>
            <div class="d-flex align-items-center">
              <%= form.select :category_id,
                  Category.income.map { |c| [c.name, c.id, { 'data-description' => c.description }] },
                  { prompt: "Selecione uma categoria" },
                  { class: "form-select", id: "income_category_select" } %>
              <span class="ms-2" id="income_category_tooltip" style="display: none;">
                <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" data-bs-placement="right" title=""></i>
              </span>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <%= form.submit "Adicionar Receita", class: "btn btn-success" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Adicionar Despesa -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="expenseModalLabel">
          <i class="fas fa-minus-circle"></i> Adicionar Despesa
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: [@current_user.family, Transaction.new], url: transactions_path, local: true, html: { class: "transaction-form" } do |form| %>
          <%= form.hidden_field :transaction_type, value: "expense" %>

          <div class="mb-3">
            <%= form.label :description, "Descrição", class: "form-label" %>
            <%= form.text_field :description, class: "form-control", placeholder: "Ex: Supermercado, Conta de Luz, etc." %>
          </div>

          <div class="mb-3">
            <%= form.label :amount, "Valor (R$)", class: "form-label" %>
            <%= form.number_field :amount, step: 0.01, min: 0, class: "form-control", placeholder: "0,00" %>
          </div>

          <div class="mb-3">
            <%= form.label :transaction_date, "Data", class: "form-label" %>
            <%= form.date_field :transaction_date, class: "form-control", value: Date.current %>
          </div>

          <div class="mb-3">
            <%= form.label :category_id, "Categoria", class: "form-label" %>
            <div class="d-flex align-items-center">
              <%= form.select :category_id,
                  Category.expense.map { |c| [c.name, c.id, { 'data-description' => c.description }] },
                  { prompt: "Selecione uma categoria" },
                  { class: "form-select", id: "expense_category_select" } %>
              <span class="ms-2" id="expense_category_tooltip" style="display: none;">
                <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" data-bs-placement="right" title=""></i>
              </span>
            </div>
          </div>

          <div class="mb-3 form-check">
            <%= form.check_box :is_recurring, class: "form-check-input", id: "expense_recurring_checkbox" %>
            <%= form.label :is_recurring, "Transação recorrente", class: "form-check-label" %>
          </div>

          <div class="mb-3" id="recurring-frequency-expense" style="display: none;">
            <%= form.label :recurring_frequency, "Frequência", class: "form-label" %>
            <%= form.select :recurring_frequency,
                options_for_select([
                  ['Semanal', 'weekly'],
                  ['Mensal', 'monthly'],
                  ['Trimestral', 'quarterly'],
                  ['Anual', 'yearly']
                ]),
                { prompt: "Selecione a frequência" },
                { class: "form-select" } %>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <%= form.submit "Adicionar Despesa", class: "btn btn-danger" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to update category tooltip
  function updateCategoryTooltip(selectElement, tooltipElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];

    if (selectedOption && selectedOption.getAttribute('data-description')) {
      const description = selectedOption.getAttribute('data-description');
      const tooltipIcon = tooltipElement.querySelector('i');

      tooltipIcon.setAttribute('title', description);
      tooltipIcon.setAttribute('data-bs-original-title', description);

      tooltipElement.style.display = 'inline-block';

      // Initialize Bootstrap tooltip
      if (window.bootstrap) {
        new bootstrap.Tooltip(tooltipIcon);
      }
    } else {
      tooltipElement.style.display = 'none';
    }
  }

  // Income category select handler
  const incomeCategorySelect = document.getElementById('income_category_select');
  const incomeCategoryTooltip = document.getElementById('income_category_tooltip');

  if (incomeCategorySelect && incomeCategoryTooltip) {
    incomeCategorySelect.addEventListener('change', function() {
      updateCategoryTooltip(this, incomeCategoryTooltip);
    });
  }

  // Expense category select handler
  const expenseCategorySelect = document.getElementById('expense_category_select');
  const expenseCategoryTooltip = document.getElementById('expense_category_tooltip');

  if (expenseCategorySelect && expenseCategoryTooltip) {
    expenseCategorySelect.addEventListener('change', function() {
      updateCategoryTooltip(this, expenseCategoryTooltip);
    });
  }

  // Toggle recurring frequency fields
  const recurringCheckboxes = document.querySelectorAll('input[name="transaction[is_recurring]"]');

  recurringCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const modal = this.closest('.modal');
      const frequencyDiv = modal.querySelector('[id^="recurring-frequency"]');

      if (this.checked) {
        frequencyDiv.style.display = 'block';
      } else {
        frequencyDiv.style.display = 'none';
      }
    });
  });

  // Reset modals when closed
  document.getElementById('incomeModal').addEventListener('hidden.bs.modal', function() {
    const tooltip = document.getElementById('income_category_tooltip');
    if (tooltip) {
      tooltip.style.display = 'none';
    }
  });

  document.getElementById('expenseModal').addEventListener('hidden.bs.modal', function() {
    const tooltip = document.getElementById('expense_category_tooltip');
    const frequencyDiv = document.getElementById('recurring-frequency-expense');

    if (tooltip) {
      tooltip.style.display = 'none';
    }

    if (frequencyDiv) {
      frequencyDiv.style.display = 'none';
    }
  });
});
</script>
